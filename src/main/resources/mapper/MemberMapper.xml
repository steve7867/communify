<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.communify.domain.member.MemberRepository">
    <insert id="insert" useGeneratedKeys="true">
        INSERT INTO member(email, hashed, name)
        VALUES (#{email}, #{hashed}, #{name})
    </insert>

    <select id="findMemberInfoForLoginByEmail">
        SELECT id, hashed, name
        FROM member
        WHERE email = #{email}
    </select>

    <select id="findMemberInfoForSearch">
        SELECT id,
               email,
               name,
               follower_count,
               followee_count,
               IF(f.follower_id IS NOT NULL, TRUE, FALSE) AS is_following,
               created_timestamp
        FROM member m
            LEFT OUTER JOIN follow f ON m.id = f.followee_id AND f.follower_id = #{searcherId}
        WHERE id = #{memberId}
    </select>

    <select id="findHashed">
        SELECT hashed
        FROM member
        WHERE id = #{memberId}
    </select>

    <delete id="deleteById">
        DELETE
        FROM member
        WHERE id = #{memberId}
    </delete>

    <insert id="setToken">
        INSERT INTO token(member_id, token)
        VALUES (#{memberId}, #{token})
    </insert>

    <select id="findTokenById">
        SELECT token
        FROM token
        WHERE member_id = #{memberId}
    </select>

    <select id="findTokensOfFollowers">
        SELECT t.token
        FROM follow f
                 INNER JOIN member m ON f.follower_id = m.id
                 LEFT OUTER JOIN token t ON m.id = t.member_id
        WHERE f.followee_id = #{writerId}
    </select>

    <update id="updatePassword">
        UPDATE member
        SET hashed = #{newHashed}
        WHERE id = #{memberId}
    </update>

    <update id="incFollowerCount">
        UPDATE member
        SET follower_count = follower_count + #{count}
        WHERE id = #{followeeId}
    </update>

    <update id="incFolloweeCount">
        UPDATE member
        SET followee_count = followee_count + #{count}
        WHERE id = #{followerId}
    </update>

    <update id="decFollowerCount">
        UPDATE member
        SET follower_count = follower_count - #{count}
        WHERE id = #{followeeId}
    </update>

    <update id="decFolloweeCount">
        UPDATE member
        SET followee_count = followee_count - #{count}
        WHERE id = #{followerId}
    </update>

    <update id="decFollowerCountOfFollowees">
        UPDATE member
        SET follower_count = follower_count - #{count}
        WHERE id IN (SELECT followee_id
                     FROM follow
                     WHERE follower_id = #{followerId})
    </update>

    <update id="decFolloweeCountOfFollowers">
        UPDATE member
        SET followee_count = followee_count - #{count}
        WHERE id IN (SELECT follower_id
                     FROM follow
                     WHERE followee_id = #{followeeId})
    </update>

    <select id="findTokenOfPostWriter">
        SELECT t.token
        FROM post p
            LEFT OUTER JOIN member m ON p.writer_id = m.id
            LEFT OUTER JOIN token t ON m.id = t.member_id
        WHERE p.id = #{postId}
    </select>
</mapper>
